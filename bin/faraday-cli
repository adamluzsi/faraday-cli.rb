#!/usr/bin/env ruby
if ENV['FARADAY_CLI_DEVELOPER_ENV'] == 'true'
  $LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))
end

require 'faraday/cli'

CLI_OPTIONS = Faraday::CLI::Option::Parser.new.parse!
Faraday::CLI::Option::Validator.validate(CLI_OPTIONS)

connection = Faraday.new do |builder|
  builder.use Faraday::Response::RaiseError

  unless CLI_OPTIONS[:flags].include?(:without_middlewares)
    Faraday::CLI::MiddlewareFetcher.extend!(builder, *CLI_OPTIONS[:config_file_paths])
  end

  builder.request(:multipart) if CLI_OPTIONS[:flags].include?(:multipart)

  if CLI_OPTIONS[:flags].include?(:verbose)
    builder.response :logger
  end

  if CLI_OPTIONS[:flags].include?(:super_verbose)
    builder.use Faraday::CLI::Middleware::VerboseRequest
    builder.use Faraday::CLI::Middleware::VerboseResponse
  end

  builder.adapter(Faraday.default_adapter)
end

if CLI_OPTIONS[:flags].include?(:show_middlewares)
  $stdout.puts(connection.builder.handlers.map(&:inspect))
  exit
end

FARADAY_ACTIVE_CONNECTION= connection

def active_connection
  FARADAY_ACTIVE_CONNECTION
end

begin

  response = connection.public_send(CLI_OPTIONS[:http_method].downcase) do |request|

    raise('Missing URL for request!') if ARGV[0].nil?
    request.url(ARGV[0])

    CLI_OPTIONS[:http_headers].each do |key, value|
      request.headers[key]=value
    end

    CLI_OPTIONS[:params].each do |key, value|
      request.params[key]=value
    end

    request.body = CLI_OPTIONS[:body] unless CLI_OPTIONS[:body].nil?

  end

  $stdout.puts(response.body)

rescue Faraday::ClientError => ex
  $stdout.puts(ex.message)
  $stdout.puts(ex.response[:body]) unless ex.response.nil?
  exit(1)

rescue URI::InvalidURIError => ex
  $stdout.puts(ex.message)
  exit(1)

end